#### 什么是etcd？

一个键值存储仓库，可以用于配置共享和服务发现。

其特点是：

- 完全复制：集群的每个节点都可以使用完整的存档
- 高可用性：避免单点故障
- 一致性：，每次读取都会返回跨主机的最新写入

- 简单，基于HTTP+JSON的API（gRPC）
- 安全，可选SSL客户认证机制
- 快速，每个实例每秒支持一千次写操作
- 可靠，使用Raft算法实现分布式

#### 应用场景

##### 服务发现

解决分布式系统最常见的问题之一即同一个分布式集群中的进程或服务如何才能找到对方并建立连接。

本质上来说，就是要了解集群中是否有进程在监听udp或tcp端口并且通过名字就可以查找和链接。

需要三个核心组件

- 强一致性、高可用性的服务存储目录
  - 基于Raft算法的etcd
- 注册服务和健康服务、健康状况的机制
  - etcd中注册服务，并对注册的服务配置key TTL，定时保持服务的心跳达到监控健康状况的效果。
- 查找和连接服务的机制
  - 在etcd指定主题下注册的服务也能在对应的主题下查找到，可以在每个服务器上部署一个proxy模式的etcd，可以确保访问etcd集群的服务都能互相连接。

##### 配置中心

一些配置信息放在etcd上进行集中管理，应用在启动时主动从etcd获取一次配置信息，同时在etcd节点上注册一个Watcher并等待，每次配置更新时，etcd都会通知订阅者，达到更新配置信息的目的

#### 分布式锁

保持独占，即所有获取锁的用户最终只有一个可以得到，etcd为此提供了一套实现了分布式锁原子操作CAS的API，通过设置prevExist值，可以保证多个节点同时去创建目录时只有一个能成功。

控制时序，即所有想要获取锁的用户都会被安排执行，但是获取锁的顺序也是全局唯一的，同时决定了执行顺序。etcd为此提供了一套API（自动创建有序键），对一个目录建立值时指定POST动作，

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201218203255866.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjA1Mjcy,size_16,color_FFFFFF,t_70)

HTTP Server，用于处理用户发送的API请求以及与其他etcd节点的同步和心跳信息

Store，处理etcd支持的各类功能的事物，包括数据索引、节点状态变更、监控与反馈、事件处理与执行

Raft，etcd核心，强一致性算法的实现

WAL，预写式日志，etcd的数据存储方式，除了在内存中存有所有数据的状态以及节点的索引以外，etcd就通过WAL进行持久化存储。所有数据的提交前都会实现记录日志，Entry表示存储的具体日志内容



#### ETCD3.0

- 客户端通信方式使用gRPC（使用了HTTP/2，多路复用）而不是HTTP+JSON

- 键过期机制采用租约机制，每个租约一个TTL，租约过期后，key就被删除，用于实现服务注册功能，同时引入心跳机制检查健康状态

  之前的版本采用的是TTL机制，每个有存活时间的键，客户端必须定期刷新保证不被自动删除

- watch机制不再通过滑动窗口实现（可能不可靠），而是通过多路复用和MVVC支持get和watch键的历史版本

- 数据存储模型从内存数据库修改为磁盘数据库，底层引擎使用的BoltDB，支持MVVC机制，不再使用目录式层级化设计而是采用线段树优化查询

- 采用MVVC的原因是MVVC很好的解决了锁带来的问题，每当需要更改或删除时，DBMS不再在原地删除或修改，而是增加一个新版本，并发读取的操作就可以无需加锁地读取旧版本数据，写操作也不会被阻塞。实现了高效的读写并发，适合读多写少的场景

- v2版本中数据通过WAL和Snapshot来持久化数据（先写到WAL中，当通过Raft将WAL同步到所有分布式节点后，再将WAL中的数据写入内存，同时WAL日志可以支持redo和undo操作从而实现恢复和回滚功能，而Snapshot和Redis的RDB和AOF日志很像，WAL日志可对标Redis的AOF日志，Snapshot可对标Redis的RDB日志，在Redis中进行节点数据同步时，先全量同步RDB日志，然后再增量同步AOF日志，但在ETCD中，先通过Snapshot，再同步WAL日志，当WAL数据做完快照后，就可以将旧的WAL数据删除），而v3中使用MVVC所以数据必须落盘，但为了防止数据存储随着时间推移而无限增长，ETCD会压缩历史数据即删除BoltDB中旧版本的数据

- Snapshot是通过Copy-on-Write完成的，当需要进行快照时，如果数据有更新，则生成一个数据副本，如果数据未更新，则直接落盘，数据如果更新则同步副本数据即可。【TODO】